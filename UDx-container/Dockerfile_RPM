# -*- mode: shell-script -*-
# (c) Copyright [2021-2023] Open Text.
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
##############################################################################

# Base operating system
ARG os_version
ARG os_image

FROM ${os_image}:${os_version}

ENV VERTICA_OPT_DIR="/opt/vertica"

ARG vertica_db_user="dbadmin"
ARG vertica_db_group="verticadba"
ARG dbadmin_gid=1000
ARG dbadmin_id=1000

ENV VERTICA_HOME_DIR="/home/$vertica_db_user"

# name of .rpm file
ARG RPM
ARG vertica_version

COPY $RPM /tmp/$RPM

# Add yum repos
RUN --mount=type=cache,target=/var/cache/yum/${TARGETOS}/${TARGETARCH} yum install -y epel-release && yum clean all
RUN --mount=type=cache,target=/var/cache/yum/${TARGETOS}/${TARGETARCH} yum install -y dnf-plugins-core epel-release && yum clean all
RUN yum config-manager --enable powertools
RUN --mount=type=cache,target=/var/cache/yum/${TARGETOS}/${TARGETARCH} yum install -y dnf-plugins-core && yum clean all

# Install Development Tools and packages needed for C++ UDx development
RUN --mount=type=cache,target=/var/cache/yum/${TARGETOS}/${TARGETARCH} dnf group install -y "Development Tools"
RUN --mount=type=cache,target=/var/cache/yum/${TARGETOS}/${TARGETARCH} yum install -y \
        binutils \
        boost \
        bzip2-devel \
        cmake \
        doxygen \
        expat \
        flex \
        gcc-c++ \
        gcc-gfortran \
        gdb \
        gettext \
        git-all \
        glibc-devel \
        glibc-headers \
        glibc-langpack-en \
        glibc-locale-source \
        glibc-static \
        glibc-utils \
        imake \
        iproute \
        less \
        libasan \
        libacl-devel \
        libcurl-devel \
        libgfortran-* \
        libgomp-* \
        libstdc++-static \
        libtool \
        make \
        nasm \
        openssl-devel \
        readline-devel \
        sudo \
        tar \
        vim \
        wget \
        which \
        && yum clean all

# RHEL8 and their clones don't have a "python" binary, so define the symlink to point to python3.
RUN alternatives --set python /usr/bin/python3

# Install Vertica package (for SDK headers and libraries only)
RUN yum localinstall -q -y /tmp/$RPM && rm -f /tmp/$RPM

RUN localedef -i en_US -f UTF-8 en_US.UTF-8

# Create development user
RUN /usr/sbin/groupadd -r -g $dbadmin_gid $vertica_db_group \
    && /usr/sbin/useradd -r \
                          -m \
                          -s /bin/bash \
                          --uid $dbadmin_id \
                          -g $vertica_db_group \
                          $vertica_db_user 

RUN chown -R $vertica_db_user:$vertica_db_group ${VERTICA_OPT_DIR} \
    && chown -R $vertica_db_user:$vertica_db_group ${VERTICA_HOME_DIR} \
    && chmod 755 ${VERTICA_HOME_DIR} \
    # Allow passwordless sudo access from any user
    && echo "ALL ALL=(ALL) NOPASSWD: ALL" | tee -a /etc/sudoers

ADD ./env_setup/vertica_env.sh /etc/profile.d/
COPY entrypoint.sh /opt/vertica/bin/entrypoint.sh

# Run as development user
USER $vertica_db_user

WORKDIR ${VERTICA_HOME_DIR}

ENTRYPOINT  [ "/opt/vertica/bin/entrypoint.sh" ]

LABEL image_name="vertica_udx_development"
LABEL os_family="$CONTAINER_OS"
LABEL os_version="$CONTAINER_OS_VERSION"
LABEL vertica_version="$VERTICA_VERSION"
LABEL maintainer="K8 Team"
